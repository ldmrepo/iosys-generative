"""
Prompt Templates for Similar Question Generation with Vision Support
"""

from dataclasses import dataclass, field
from typing import Optional

# System Prompt (Base)
SYSTEM_PROMPT_BASE = """ë‹¹ì‹ ì€ í•œêµ­ êµìœ¡ê³¼ì •ì— ë§ëŠ” ë¬¸í•­ì„ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ ì›ë³¸ ë¬¸í•­ì„ ë¶„ì„í•˜ê³ , ë™ì¼í•œ í•™ìŠµ ëª©í‘œë¥¼ í‰ê°€í•˜ëŠ” ìœ ì‚¬ ë¬¸í•­ì„ ìƒì„±í•©ë‹ˆë‹¤.

## ì¶œë ¥ í˜•ì‹
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.

```json
{
  "items": [
    {
      "question": "ë¬¸ì œ í…ìŠ¤íŠ¸ (HTML íƒœê·¸ ì—†ì´)",
      "choices": ["â‘  ë³´ê¸°1", "â‘¡ ë³´ê¸°2", "â‘¢ ë³´ê¸°3", "â‘£ ë³´ê¸°4", "â‘¤ ë³´ê¸°5"],
      "answer": "ì •ë‹µ (ê°ê´€ì‹: â‘ â‘¡â‘¢â‘£â‘¤ ì¤‘ í•˜ë‚˜, ë‹¨ë‹µí˜•: ë‹µ í…ìŠ¤íŠ¸)",
      "explanation": "í•´ì„¤",
      "variation_note": "ì›ë³¸ ëŒ€ë¹„ ë³€ê²½ ì‚¬í•­ ìš”ì•½",
      "uses_original_image": true/false,
      "image_reference_note": "ì´ë¯¸ì§€ ì°¸ì¡° ë°©ì‹ ì„¤ëª… (ì´ë¯¸ì§€ ë¬¸í•­ì¸ ê²½ìš°)"
    }
  ]
}
```

## í•„ìˆ˜ ê·œì¹™
1. ì›ë³¸ ë¬¸í•­ì˜ **í•™ìŠµ ëª©í‘œ**ì™€ **í‰ê°€ ìš”ì†Œ**ë¥¼ ë°˜ë“œì‹œ ìœ ì§€
2. **í•™ë…„, ê³¼ëª©, ë‚œì´ë„**ë¥¼ ì›ë³¸ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
3. **ì •ë‹µì´ ëª…í™•**í•´ì•¼ í•¨ (ëª¨í˜¸í•œ ë¬¸í•­ ê¸ˆì§€)
4. ê°ê´€ì‹ì˜ ê²½ìš° **ì˜¤ë‹µë„ ê·¸ëŸ´ë“¯**í•˜ê²Œ ì‘ì„± (ëª…ë°±íˆ í‹€ë¦° ë³´ê¸° ê¸ˆì§€)
5. **í•œêµ­ì–´ ë§ì¶¤ë²•**ê³¼ **êµìœ¡ ìš©ì–´**ë¥¼ ì •í™•íˆ ì‚¬ìš©
6. ì›ë³¸ê³¼ **70-80% ìœ ì‚¬**í•˜ë˜ **ë‹¨ìˆœ ë³µì‚¬ëŠ” ê¸ˆì§€**
7. ë‹¨ë‹µí˜•/ì„œìˆ í˜•ì˜ ê²½ìš° choicesëŠ” ë¹ˆ ë°°ì—´ []ë¡œ ì„¤ì •

## ë¬¸í•­ ìœ í˜•ë³„ ì§€ì¹¨

### ê°ê´€ì‹
- ë³´ê¸°ëŠ” ë°˜ë“œì‹œ 5ê°œ (â‘ â‘¡â‘¢â‘£â‘¤)
- ì •ë‹µì€ í•˜ë‚˜ë§Œ ì¡´ì¬
- ì˜¤ë‹µì€ í•™ìƒë“¤ì´ í”íˆ í•˜ëŠ” ì‹¤ìˆ˜ë¥¼ ë°˜ì˜

### ë‹¨ë‹µí˜•
- ì •ë‹µì€ ëª…í™•í•œ ë‹¨ì–´/ìˆ«ì/ìˆ˜ì‹
- ë™ì¹˜ì¸ ë‹µì´ ìˆìœ¼ë©´ ëª¨ë‘ ëª…ì‹œ (ì˜ˆ: "2" ë˜ëŠ” "ì´")
- choicesëŠ” ë¹ˆ ë°°ì—´ []

### ì„œìˆ í˜•
- ì±„ì  ê¸°ì¤€ì´ ëª…í™•í•˜ë„ë¡ ëª¨ë²”ë‹µì•ˆ ì œì‹œ
- ë¶€ë¶„ ì ìˆ˜ ê¸°ì¤€ í¬í•¨ ê°€ëŠ¥
- choicesëŠ” ë¹ˆ ë°°ì—´ []

## ë³€í˜• ìœ í˜•

### numeric (ìˆ«ì ë³€í˜•)
- ìˆ«ì, ìˆ˜ì¹˜, ê³„ìˆ˜ë§Œ ë³€ê²½
- ê³„ì‚° ê²°ê³¼ê°€ ìì—°ìˆ˜ ë˜ëŠ” ê°„ë‹¨í•œ ë¶„ìˆ˜ê°€ ë˜ë„ë¡
- ì˜ˆ: "2x + 3 = 7" â†’ "3x + 2 = 11"

### context (ë§¥ë½ ë³€í˜•)
- ì´ë¦„, ì¥ì†Œ, ì‚¬ë¬¼, ìƒí™© ë³€ê²½
- ë¬¸ì œì˜ ìˆ˜í•™ì /ë…¼ë¦¬ì  êµ¬ì¡°ëŠ” ìœ ì§€
- ì˜ˆ: "ì² ìˆ˜ê°€ ì‚¬ê³¼ 5ê°œ" â†’ "ì˜í¬ê°€ ê·¤ 8ê°œ"

### structure (êµ¬ì¡° ë³€í˜•)
- ì§ˆë¬¸ ë°©ì‹ì´ë‚˜ í˜•íƒœ ë³€ê²½
- ê°™ì€ ê°œë…ì„ ë‹¤ë¥¸ ê°ë„ì—ì„œ í‰ê°€
- ì˜ˆ: "ë‹¤ìŒ ì¤‘ ì˜³ì€ ê²ƒì€?" â†’ "ë‹¤ìŒ ì¤‘ ì˜³ì§€ ì•Šì€ ê²ƒì€?"

### mixed (ë³µí•© ë³€í˜•)
- ìœ„ ë³€í˜•ë“¤ì„ ì ì ˆíˆ ì¡°í•©
- ê°€ì¥ ìì—°ìŠ¤ëŸ¬ìš´ ë³€í˜• ì„ íƒ"""


# Vision-specific System Prompt Extension
SYSTEM_PROMPT_VISION_EXT = """

## ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¬¸í•­ ìƒì„± ì§€ì¹¨ (Vision)

ë‹¹ì‹ ì€ ì²¨ë¶€ëœ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì´ë¯¸ì§€ ë¶„ì„ ì ˆì°¨
1. **ì‹œê°ì  ìš”ì†Œ íŒŒì•…**: ë„í˜•, ê·¸ë˜í”„, í‘œ, ë‹¤ì´ì–´ê·¸ë¨ ë“± í™•ì¸
2. **ìˆ˜ì¹˜/ë ˆì´ë¸” ì¶”ì¶œ**: ì´ë¯¸ì§€ì— í‘œì‹œëœ ëª¨ë“  ìˆ«ì, ë¬¸ì, ê¸°í˜¸ ì •í™•íˆ ì½ê¸°
3. **ê´€ê³„ íŒŒì•…**: ìš”ì†Œë“¤ ê°„ì˜ ê¸°í•˜í•™ì /ë…¼ë¦¬ì  ê´€ê³„ ì´í•´
4. **ê²€ì¦**: ì¶”ì¶œí•œ ì •ë³´ê°€ ë¬¸ì œ í…ìŠ¤íŠ¸ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸

### ì´ë¯¸ì§€ ê¸°ë°˜ ë¬¸í•­ ìƒì„± ê·œì¹™
1. **ì›ë³¸ ì´ë¯¸ì§€ ìœ ì§€**: ë™ì¼í•œ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¬¸í•­ ìƒì„± ê°€ëŠ¥
   - ì´ë¯¸ì§€ ë‚´ ìš”ì†Œ(ì¢Œí‘œ, ê¸¸ì´, ê°ë„ ë“±)ë¥¼ ì •í™•íˆ ì°¸ì¡°
   - ë‹¤ë¥¸ ê´€ì ì—ì„œ ì§ˆë¬¸ (ì˜ˆ: "ë„“ì´ë¥¼ êµ¬í•˜ì‹œì˜¤" â†’ "ë‘˜ë ˆë¥¼ êµ¬í•˜ì‹œì˜¤")
   - `uses_original_image: true` ì„¤ì •

2. **ì´ë¯¸ì§€ ë…ë¦½ ë¬¸í•­**: ì´ë¯¸ì§€ ì—†ì´ ì„±ë¦½í•˜ëŠ” ë¬¸í•­ ìƒì„±
   - ì´ë¯¸ì§€ì˜ ê°œë…ë§Œ ì°¨ìš©í•˜ì—¬ í…ìŠ¤íŠ¸ë¡œ ì„¤ëª…
   - ìƒˆë¡œìš´ ìˆ˜ì¹˜ë¡œ ìœ ì‚¬í•œ êµ¬ì¡°ì˜ ë¬¸ì œ ìƒì„±
   - `uses_original_image: false` ì„¤ì •

3. **ìˆ˜í•™ì  ì •í™•ì„±**
   - ì´ë¯¸ì§€ì—ì„œ ì½ì€ ìˆ˜ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •ë‹µ ê³„ì‚°
   - ê³„ì‚° ê³¼ì •ì„ í•´ì„¤ì— í¬í•¨
   - ì´ë¯¸ì§€ì™€ ëª¨ìˆœë˜ëŠ” ë¬¸í•­ ìƒì„± ê¸ˆì§€

### image_reference_note ì‘ì„±
ì´ë¯¸ì§€ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²½ìš°, ì–´ë–¤ ìš”ì†Œë¥¼ ì–´ë–»ê²Œ í™œìš©í–ˆëŠ”ì§€ ëª…ì‹œ:
- "ì›ë³¸ ê·¸ë˜í”„ì˜ yì ˆí¸ì„ í™œìš©í•˜ì—¬ xì ˆí¸ì„ ë¬»ëŠ” ë¬¸í•­ìœ¼ë¡œ ë³€í˜•"
- "ì‚¼ê°í˜• ABCì˜ ë³€ ê¸¸ì´ë¥¼ ìœ ì§€í•˜ê³  ê°ë„ë¥¼ ë¬»ëŠ” ë¬¸í•­ìœ¼ë¡œ ë³€í˜•"
- "ì›ë³¸ í‘œì˜ êµ¬ì¡°ë¥¼ ì°¨ìš©í•˜ì—¬ ìƒˆë¡œìš´ ìˆ˜ì¹˜ë¡œ ë…ë¦½ ë¬¸í•­ ìƒì„±"

### í™˜ê°(Hallucination) ë°©ì§€
- ì´ë¯¸ì§€ì— **ëª…ì‹œì ìœ¼ë¡œ í‘œì‹œëœ ì •ë³´ë§Œ** ì‚¬ìš©
- ì´ë¯¸ì§€ì— ì—†ëŠ” ìˆ˜ì¹˜ë¥¼ ì¶”ì¸¡í•˜ì§€ ì•ŠìŒ
- ë¶ˆí™•ì‹¤í•œ ê²½ìš° `uses_original_image: false`ë¡œ ë…ë¦½ ë¬¸í•­ ìƒì„±"""


# User Prompt Template
USER_PROMPT_TEMPLATE = """## ì›ë³¸ ë¬¸í•­

**ê³¼ëª©**: {subject}
**í•™ë…„**: {grade}
**ë‚œì´ë„**: {difficulty}
**ë¬¸í•­ìœ í˜•**: {question_type}
**ë‹¨ì›**: {unit}

**ë¬¸ì œ**:
{question_text}

**ë³´ê¸°**:
{choices}

**ì •ë‹µ**: {answer}

**í•´ì„¤**:
{explanation}

---

## ìƒì„± ìš”ì²­

- **ìƒì„± ê°œìˆ˜**: {count}ê°œ
- **ë³€í˜• ìœ í˜•**: {variation_type}
- **ì¶”ê°€ ì¡°ê±´**: {additional_prompt}

ìœ„ ì›ë³¸ ë¬¸í•­ì„ ê¸°ë°˜ìœ¼ë¡œ {count}ê°œì˜ ìœ ì‚¬ ë¬¸í•­ì„ ìƒì„±í•´ì£¼ì„¸ìš”."""


# Vision-specific User Prompt Extension
USER_PROMPT_VISION_EXT = """

---

## ğŸ–¼ï¸ ì´ë¯¸ì§€ ì •ë³´

ì´ ë¬¸í•­ì—ëŠ” ì´ë¯¸ì§€ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì²¨ë¶€ëœ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ë¶„ì„í•˜ì—¬ ë¬¸í•­ì„ ìƒì„±í•˜ì„¸ìš”.

### ì´ë¯¸ì§€ ë¶„ì„ ìš”ì²­
1. ì´ë¯¸ì§€ì— í‘œì‹œëœ ëª¨ë“  ìˆ˜ì¹˜, ë ˆì´ë¸”, ê¸°í˜¸ë¥¼ íŒŒì•…í•˜ì„¸ìš”
2. ë„í˜•/ê·¸ë˜í”„/í‘œì˜ êµ¬ì¡°ì™€ ê´€ê³„ë¥¼ ì´í•´í•˜ì„¸ìš”
3. ì›ë³¸ ë¬¸ì œê°€ ì´ë¯¸ì§€ì˜ ì–´ë–¤ ìš”ì†Œë¥¼ ë¬»ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”

### ìƒì„± ì‹œ ì£¼ì˜ì‚¬í•­
- ì´ë¯¸ì§€ì˜ ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ì°¸ì¡°í•˜ì„¸ìš”
- ì´ë¯¸ì§€ì— ì—†ëŠ” ì •ë³´ë¥¼ ë§Œë“¤ì–´ë‚´ì§€ ë§ˆì„¸ìš”
- ê° ë¬¸í•­ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì–´ë–»ê²Œ í™œìš©í–ˆëŠ”ì§€ `image_reference_note`ì— ëª…ì‹œí•˜ì„¸ìš”"""


# Variation Type Instructions
VARIATION_INSTRUCTIONS = {
    "numeric": """
### ìˆ«ì ë³€í˜• ì„¸ë¶€ ì§€ì¹¨
- ëª¨ë“  ìˆ«ìë¥¼ ë³€ê²½í•˜ë˜, ê³„ì‚° ê°€ëŠ¥í•œ ë²”ìœ„ ìœ ì§€
- ìŒìˆ˜ë‚˜ ë³µì¡í•œ ë¶„ìˆ˜ëŠ” í”¼í•¨
- ë³€ê²½ëœ ìˆ«ìë¡œ ë¬¸ì œë¥¼ ë‹¤ì‹œ í’€ì–´ ì •ë‹µ í™•ì¸
- ì˜ˆì‹œ:
  - ì›ë³¸: "x + 5 = 12ì¼ ë•Œ xì˜ ê°’ì€?"
  - ë³€í˜•: "x + 7 = 15ì¼ ë•Œ xì˜ ê°’ì€?"
""",

    "context": """
### ë§¥ë½ ë³€í˜• ì„¸ë¶€ ì§€ì¹¨
- ì¸ë¬¼ëª…: í•œêµ­ì‹ ì´ë¦„ ì‚¬ìš© (ì² ìˆ˜, ì˜í¬, ë¯¼ìˆ˜, ì§€ì˜ ë“±)
- ì¥ì†Œ: í•œêµ­ ì§€ëª…ì´ë‚˜ ì¼ë°˜ì  ì¥ì†Œ (ì„œìš¸, í•™êµ, ê³µì› ë“±)
- ì‚¬ë¬¼: ì¼ìƒì ì´ê³  ì¹œìˆ™í•œ ê²ƒ (ì‚¬ê³¼, ì—°í•„, ê³µì±… ë“±)
- ìƒí™©: í•™ìƒë“¤ì—ê²Œ ì¹œìˆ™í•œ ë§¥ë½ ìœ ì§€
- ì˜ˆì‹œ:
  - ì›ë³¸: "ì² ìˆ˜ê°€ ì‚¬ê³¼ 5ê°œë¥¼ ìƒ€ë‹¤"
  - ë³€í˜•: "ì˜í¬ê°€ ê·¤ 5ê°œë¥¼ ìƒ€ë‹¤"
""",

    "structure": """
### êµ¬ì¡° ë³€í˜• ì„¸ë¶€ ì§€ì¹¨
- ì§ˆë¬¸ í˜•íƒœ ë³€ê²½ (ê¸ì •â†”ë¶€ì •, ì„ íƒâ†”ì„œìˆ )
- ì¡°ê±´ê³¼ ê²°ë¡  ìœ„ì¹˜ êµí™˜
- ê·¸ë˜í”„/í‘œ í•´ì„ â†” ê³„ì‚° ë¬¸ì œ
- ì£¼ì˜: ë‚œì´ë„ê°€ í¬ê²Œ ë³€í•˜ì§€ ì•Šë„ë¡
- ì˜ˆì‹œ:
  - ì›ë³¸: "ë‹¤ìŒ ì¤‘ ì˜³ì€ ê²ƒì€?"
  - ë³€í˜•: "ë‹¤ìŒ ì¤‘ ì˜³ì§€ ì•Šì€ ê²ƒì€?" (ë³´ê¸°ì™€ ì •ë‹µë„ ì¡°ì •)
""",

    "mixed": """
### ë³µí•© ë³€í˜• ì„¸ë¶€ ì§€ì¹¨
- ê°€ì¥ ìì—°ìŠ¤ëŸ¬ìš´ ë³€í˜• ì¡°í•© ì„ íƒ
- í•œ ë²ˆì— ë„ˆë¬´ ë§ì€ ìš”ì†Œë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ
- ì›ë³¸ì˜ í•µì‹¬ í‰ê°€ ìš”ì†ŒëŠ” ë°˜ë“œì‹œ ìœ ì§€
- ë³€í˜• ë…¸íŠ¸ì— ì–´ë–¤ ë³€í˜•ì„ ì ìš©í–ˆëŠ”ì§€ ëª…ì‹œ
""",

    "auto": """
### ìë™ ë³€í˜• ì„¸ë¶€ ì§€ì¹¨
- ë¬¸í•­ íŠ¹ì„±ì— ë”°ë¼ ê°€ì¥ ì í•©í•œ ë³€í˜• ë°©ì‹ ìë™ ì„ íƒ
- ìˆ˜í•™ ë¬¸í•­: numeric ìš°ì„ 
- êµ­ì–´/ì‚¬íšŒ ë¬¸í•­: context ìš°ì„ 
- ê³¼í•™ ë¬¸í•­: mixed ê¶Œì¥
"""
}


# Vision-specific Variation Instructions (additional)
VARIATION_INSTRUCTIONS_VISION = {
    "numeric": """
### ì´ë¯¸ì§€ ë¬¸í•­ ìˆ«ì ë³€í˜•
- ì´ë¯¸ì§€ì— í‘œì‹œëœ ìˆ˜ì¹˜ì™€ **ë‹¤ë¥¸** ìˆ˜ì¹˜ë¡œ ìƒˆ ë¬¸í•­ ìƒì„±
- ì›ë³¸ ì´ë¯¸ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (`uses_original_image: false`)
- ë¬¸ì œ í…ìŠ¤íŠ¸ì— í•„ìš”í•œ ì¡°ê±´ì„ ëª¨ë‘ ëª…ì‹œ
""",

    "context": """
### ì´ë¯¸ì§€ ë¬¸í•­ ë§¥ë½ ë³€í˜•
- ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë˜ **ì§ˆë¬¸ ê´€ì **ì„ ë³€ê²½
- ì˜ˆ: ë„“ì´ â†’ ë‘˜ë ˆ, xì¢Œí‘œ â†’ yì¢Œí‘œ
- `uses_original_image: true` ê¶Œì¥
""",

    "structure": """
### ì´ë¯¸ì§€ ë¬¸í•­ êµ¬ì¡° ë³€í˜•
- ê°™ì€ ì´ë¯¸ì§€ë¡œ ë‹¤ë¥¸ ìœ í˜•ì˜ ì§ˆë¬¸
- ì˜ˆ: "êµ¬í•˜ì‹œì˜¤" â†’ "ì°¸/ê±°ì§“ íŒë³„", ê°ê´€ì‹ â†’ ë‹¨ë‹µí˜•
- `uses_original_image: true` ê¶Œì¥
""",

    "mixed": """
### ì´ë¯¸ì§€ ë¬¸í•­ ë³µí•© ë³€í˜•
- ì¼ë¶€ ë¬¸í•­: ì›ë³¸ ì´ë¯¸ì§€ í™œìš© (ë‹¤ë¥¸ ê´€ì  ì§ˆë¬¸)
- ì¼ë¶€ ë¬¸í•­: ì´ë¯¸ì§€ ë…ë¦½ (ìƒˆ ìˆ˜ì¹˜ë¡œ í…ìŠ¤íŠ¸ ë¬¸í•­)
- ë‹¤ì–‘í•œ ì¡°í•©ìœ¼ë¡œ ë¬¸í•­ ìƒì„±
""",

    "auto": """
### ì´ë¯¸ì§€ ë¬¸í•­ ìë™ ë³€í˜•
- ì´ë¯¸ì§€ íŠ¹ì„±ì— ë”°ë¼ ìµœì  ë³€í˜• ë°©ì‹ ì„ íƒ
- ê·¸ë˜í”„: ë‹¤ë¥¸ ì /ì ˆí¸ ì§ˆë¬¸
- ë„í˜•: ë‹¤ë¥¸ ìš”ì†Œ(ë³€, ê°, ë„“ì´) ì§ˆë¬¸
- í‘œ: ë‹¤ë¥¸ í–‰/ì—´ ë°ì´í„° ì§ˆë¬¸
"""
}


# Variation Type Names (Korean)
VARIATION_TYPE_NAMES = {
    "numeric": "ìˆ«ì ë³€í˜•",
    "context": "ë§¥ë½ ë³€í˜•",
    "structure": "êµ¬ì¡° ë³€í˜•",
    "mixed": "ë³µí•© ë³€í˜•",
    "auto": "ìë™ ì„ íƒ"
}


@dataclass
class GenerationRequest:
    """Generation request parameters"""
    source_item: dict
    count: int = 3
    variation_type: str = "mixed"
    additional_prompt: str = ""
    has_images: bool = False


class PromptBuilder:
    """Build prompts for LLM generation"""

    def __init__(self):
        pass

    def get_system_prompt(self, has_images: bool = False) -> str:
        """Get system prompt, with Vision extension if images are present"""
        if has_images:
            return SYSTEM_PROMPT_BASE + SYSTEM_PROMPT_VISION_EXT
        return SYSTEM_PROMPT_BASE

    def build_user_prompt(self, request: GenerationRequest) -> str:
        """Build user prompt from generation request"""
        item = request.source_item

        # Format choices
        choices_text = self._format_choices(item.get("choices"))

        # Build base prompt
        prompt = USER_PROMPT_TEMPLATE.format(
            subject=item.get("subject", "ë¯¸ì§€ì •"),
            grade=item.get("grade", "ë¯¸ì§€ì •"),
            difficulty=item.get("difficulty", "ë¯¸ì§€ì •"),
            question_type=item.get("question_type", "ë¯¸ì§€ì •"),
            unit=item.get("unit_large", "") or item.get("unit_medium", "") or "ë¯¸ì§€ì •",
            question_text=item.get("question_text", ""),
            choices=choices_text,
            answer=item.get("answer_text", ""),
            explanation=item.get("explanation_text", "") or "(í•´ì„¤ ì—†ìŒ)",
            count=request.count,
            variation_type=VARIATION_TYPE_NAMES.get(request.variation_type, "ë³µí•© ë³€í˜•"),
            additional_prompt=request.additional_prompt or "(ì—†ìŒ)"
        )

        # Add variation instructions
        variation_instruction = VARIATION_INSTRUCTIONS.get(
            request.variation_type,
            VARIATION_INSTRUCTIONS["mixed"]
        )
        prompt += "\n\n" + variation_instruction

        # Add Vision-specific content if has images
        if request.has_images:
            prompt += USER_PROMPT_VISION_EXT

            # Add Vision-specific variation instructions
            vision_variation = VARIATION_INSTRUCTIONS_VISION.get(
                request.variation_type,
                VARIATION_INSTRUCTIONS_VISION["mixed"]
            )
            prompt += "\n\n" + vision_variation

        return prompt

    def _format_choices(self, choices: Optional[list]) -> str:
        """Format choices list to string"""
        if not choices:
            return "(ì—†ìŒ - ë‹¨ë‹µí˜•/ì„œìˆ í˜•)"

        if isinstance(choices, str):
            return choices

        if isinstance(choices, list):
            return "\n".join(str(c) for c in choices)

        return str(choices)
