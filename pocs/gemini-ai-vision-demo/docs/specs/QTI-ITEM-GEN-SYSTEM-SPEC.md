# QTI 문항 생성 시스템 명세

**문서 ID**: QTI-ITEM-GEN-SYSTEM-SPEC-001
**버전**: v1.3.0
**작성일**: 2026-02-01
**수정일**: 2026-02-02
**목적**: AI 기반 QTI 문항 생성 시스템 전체 명세

---

## 1. 시스템 개요

### 1.1 목적

기존 QTI/IML 문항을 분석하여 유사/변형 문항을 자동으로 생성하는 AI 시스템

### 1.2 핵심 기능

- **입력 처리**: QTI/IML 문항 파싱, 이미지 위치 보존
- **Vision 분석**: 문항 이미지에서 그래프, 도형, 수식, 지도 등 추출
- **문항 생성**: 원본 구조 유지 + 수치/조건 변형
- **이미지 생성**: Nano Banana Pro를 활용한 새 이미지 생성 (원본 위치 유지)
- **품질 검증**: 정답 유일성, 계산 검증, 사실 검증

### 1.3 지원 과목

| 과목 | 이미지 유형 | 특수 검증 | 비고 |
|------|------------|----------|------|
| **국어** | 지문 이미지, 도표 | AG-SAFE | 맞춤법, 문맥 검증 |
| **영어** | 지문 이미지, 도표, 그림 | AG-SAFE | 문법, 어휘 검증 |
| **수학** | 그래프, 도형, 수식, 좌표 | AG-CALC | 계산 검증 필수 |
| **과학** | 실험 도표, 그래프, 다이어그램 | AG-CALC | 단위/수치 검증 |
| **역사** | 지도, 연표, 사료 이미지 | AG-FACT, AG-SAFE | 사실 검증 필수 |
| **사회** | 지도, 통계 그래프, 도표 | AG-FACT, AG-SAFE | 통계 데이터 검증 |

---

## 2. 입력 시나리오

### 2.1 시나리오 정의

| 시나리오 | 입력 | 설명 | P2 | P3 | P5 |
|---------|------|------|:--:|:--:|:--:|
| **A** | 이미지만 | 이미지 기반 신규 문항 생성 | ✅ | ✅ | 선택 |
| **B** | 원본 문항 + 이미지 | 유사/변형 문항 생성 | ✅ | ✅ | ✅ |
| **C** | 원본 문항만 (이미지 없음) | 텍스트 기반 변형 | - | ✅ | - |

### 2.2 시나리오별 처리 흐름

#### 시나리오 A: 이미지만 입력 (신규 생성)

```
┌─────────────┐
│  입력 이미지 │
└──────┬──────┘
       │
       ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  P2-ANALYZE  │───▶│  P3-GENERATE │───▶│  P4-VALIDATE │───▶ 출력
│  Vision 분석  │    │  신규 문항    │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
```

#### 시나리오 B: 원본 + 이미지 (유사 문항 생성) ⭐ 주요 시나리오

```
┌─────────────┐    ┌─────────────┐
│ 원본 QTI/IML │    │ 원본 이미지  │
│  (텍스트)    │    │ (위치 정보)  │
└──────┬──────┘    └──────┬──────┘
       │                  │
       │           ┌──────▼──────┐
       │           │  P2-ANALYZE │
       │           │  Vision 분석 │
       │           │  → 수치 추출 │
       │           │  → 구조 분석 │
       │           └──────┬──────┘
       │                  │
       │    ┌─────────────┤ EvidencePack
       │    │             │
       ▼    ▼             │
┌──────────────┐          │
│  P3-GENERATE │◄─────────┘
│              │
│ 원본 구조 유지 │
│ + 수치 변형   │
│ + 이미지 위치 │
└──────┬───────┘
       │
       ▼
┌──────────────┐    ┌──────────────┐
│  P4-VALIDATE │───▶│  P5-OUTPUT   │
│              │    │  새 이미지    │
│              │    │ (원본 위치)   │
└──────────────┘    └──────────────┘
```

#### 시나리오 C: 원본만 (텍스트 변형)

```
┌─────────────┐
│ 원본 QTI/IML │
│  (텍스트만)  │
└──────┬──────┘
       │
       ▼
┌──────────────┐    ┌──────────────┐
│  P3-GENERATE │───▶│  P4-VALIDATE │───▶ 출력 (이미지 없음)
│  텍스트 변형  │    │              │
└──────────────┘    └──────────────┘
```

---

## 3. 변형 유형 (Variation Type)

| 유형 | 코드 | 설명 | 원본 필요 | 예시 |
|------|------|------|:--------:|------|
| **유사** | `similar` | 구조 유지, 수치만 변경 | ✅ | 85점→78점 |
| **난이도 상향** | `diff_up` | 조건 추가, 복잡도 증가 | ✅ | 2변수→3변수 |
| **난이도 하향** | `diff_down` | 조건 축소, 단순화 | ✅ | 연립방정식→일차방정식 |
| **신규 생성** | `new` | 이미지 기반 완전 새 문항 | ❌ | - |

### 3.1 과목별 변형 전략

| 과목 | similar | diff_up | diff_down | 특이사항 |
|------|---------|---------|-----------|---------|
| **국어** | 지문 유사 교체 | 추론 문항으로 | 사실 확인으로 | 저작권 주의 |
| **영어** | 어휘/문장 교체 | 문법 복합 | 단순 독해 | 난이도 어휘 DB 필요 |
| **수학** | 수치 변경 | 변수/조건 추가 | 단계 축소 | AG-CALC 필수 |
| **과학** | 수치/물질 변경 | 복합 현상 | 단일 현상 | 단위 검증 |
| **역사** | 시대/인물 변경 | 비교 분석 | 사실 확인 | AG-FACT 필수 |
| **사회** | 통계 수치 변경 | 복합 해석 | 단순 읽기 | 최신 통계 반영 |

---

## 4. 이미지 위치 보존

### 4.1 원본 이미지 위치 정보

```xml
<!-- IML 예시 -->
<물음>
    <단락>
        <문자열>다음 그래프를 보고 물음에 답하시오.</문자열>
    </단락>
    <그림 w="30.08" h="24.07" position="after_paragraph">
        이미지파일경로.png
    </그림>
    <단락>
        <문자열>위 그래프에서 최댓값은?</문자열>
    </단락>
</물음>
```

### 4.2 위치 유형

| 위치 코드 | 설명 | 예시 |
|----------|------|------|
| `before_stem` | 문제 앞 | 지문 이미지 |
| `after_stem` | 문제 뒤 | 참고 그래프 |
| `inline` | 문장 내 | 수식 이미지 |
| `in_choice` | 선지 내 | 선지별 도형 |
| `after_choice` | 선지 뒤 | 보기 이미지 |

### 4.3 위치 보존 처리

```
[P1-INPUT]
원본 이미지 위치 추출
  └─► ImagePosition {
        location: "after_stem",
        paragraph_index: 1,
        width: 30.08,
        height: 24.07
      }

[P3-GENERATE]
문항 생성 시 위치 정보 포함
  └─► DraftItem.image_positions[]

[P5-OUTPUT]
새 이미지를 원본 위치에 배치
  └─► FinalItem.images[].position = 원본과 동일
```

---

## 5. 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ITEM GENERATION SYSTEM                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐                                                        │
│  │   API GW    │◄──── REST API                                         │
│  └──────┬──────┘                                                        │
│         │                                                               │
│  ┌──────▼──────────────────────────────────────────────────────────┐   │
│  │                      PIPELINE ORCHESTRATOR                       │   │
│  │                                                                  │   │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐   │   │
│  │  │   P1   │─▶│   P2   │─▶│   P3   │─▶│   P4   │─▶│   P5   │   │   │
│  │  │ INPUT  │  │ANALYZE │  │GENERATE│  │VALIDATE│  │ OUTPUT │   │   │
│  │  │        │  │        │  │        │  │        │  │        │   │   │
│  │  │ - 파싱 │  │ -Vision│  │ - 생성 │  │ - 검증 │  │ - 이미지│   │   │
│  │  │ - 위치 │  │ - 추출 │  │ - 변형 │  │ - 계산 │  │ - 표준화│   │   │
│  │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘   │   │
│  │       │           │           │           │           │        │   │
│  │       ▼           ▼           ▼           ▼           ▼        │   │
│  │  InputPack   Evidence    DraftItem   ValReport   FinalItem     │   │
│  │  (위치정보)    Pack                                             │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                         AI MODELS                                 │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │   │
│  │  │ Gemini 3  │  │   Code    │  │   Nano    │  │  External │    │   │
│  │  │   Flash   │  │ Execution │  │  Banana   │  │   APIs    │    │   │
│  │  │           │  │           │  │    Pro    │  │           │    │   │
│  │  │ AG-VIS    │  │ AG-CALC   │  │  AG-IMG   │  │ AG-FACT   │    │   │
│  │  │ AG-GEN    │  │           │  │           │  │           │    │   │
│  │  │ AG-VAL    │  │           │  │           │  │           │    │   │
│  │  │ AG-SAFE   │  │           │  │           │  │           │    │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. AI 모델

### 6.1 Primary Models

| 모델 | Model ID | 용도 | 특징 |
|------|----------|------|------|
| Gemini 3 Flash | `gemini-3-flash-preview` | Vision 분석, 문항 생성 | 빠른 응답, 멀티모달 |
| Nano Banana Pro | `gemini-3-pro-image-preview` | 이미지 생성 | 1K/2K/4K, 텍스트 렌더링 |

### 6.2 Validation Models (Cross-Validation)

| 모델 | 용도 | 적용 레벨 |
|------|------|----------|
| GPT-4o | 교차 검증 | Level 2+ |
| Gemini Pro | 교차 검증 | Level 3+ |
| Qwen 2.5 | 교차 검증 | Level 3+ (옵션) |

### 6.3 On-Premise Options

| 모델 | 용도 | 비고 |
|------|------|------|
| Llama 3.1 70B | 교차 검증 | 자체 서버 운영 |
| EXAONE 3.5 | 한국어 특화 검증 | LG AI Research |

---

## 7. 에이전트 구성

| 에이전트 | 역할 | 사용 모델 | 적용 단계 | 적용 과목 |
|---------|------|----------|----------|----------|
| AG-VIS | Vision 분석 | Gemini 3 Flash | P2 | 전체 |
| AG-GEN | 문항 생성 | Gemini 3 Flash | P3 | 전체 |
| AG-VAL | 기본 검증 | Gemini 3 Flash | P4 | 전체 |
| AG-CALC | 계산 검증 | Code Execution | P4 | 수학, 과학 |
| AG-FACT | 사실 검증 | 외부 API | P4 | 역사, 사회 |
| AG-SAFE | 안전/편향 검증 | Gemini 3 Flash | P4 | 국어, 영어, 역사, 사회 |
| AG-IMG | 이미지 생성 | Nano Banana Pro | P5 | 전체 (이미지 있는 경우) |
| AG-STD | 표준화 | 규칙 기반 | P5 | 전체 |
| AG-AUD | 감사 로깅 | - | 전체 | 전체 |

### 7.1 과목별 에이전트 조합

| 과목 | P2 | P3 | P4 | P5 |
|------|----|----|----|----|
| **국어** | AG-VIS | AG-GEN | AG-VAL, **AG-IMG**, AG-SAFE | AG-IMG, AG-STD |
| **영어** | AG-VIS | AG-GEN | AG-VAL, **AG-IMG**, AG-SAFE | AG-IMG, AG-STD |
| **수학** | AG-VIS | AG-GEN | AG-VAL, **AG-IMG**, AG-CALC | AG-IMG, AG-STD |
| **과학** | AG-VIS | AG-GEN | AG-VAL, **AG-IMG**, AG-CALC | AG-IMG, AG-STD |
| **역사** | AG-VIS | AG-GEN | AG-VAL, **AG-IMG**, AG-FACT, AG-SAFE | AG-IMG, AG-STD |
| **사회** | AG-VIS | AG-GEN | AG-VAL, **AG-IMG**, AG-FACT, AG-SAFE | AG-IMG, AG-STD |

> **AG-IMG (P4)**: 이미지 포함 문항에만 적용 - 이미지-문항 정합성 검증

---

## 8. 데이터 흐름

### 8.1 데이터 객체

| 데이터 | 설명 | 생성 단계 | 주요 필드 |
|--------|------|----------|----------|
| **InputPack** | 원본 문항 + 메타데이터 | P1 | qti_item, images[], image_positions[] |
| **EvidencePack** | 시각 분석 결과 | P2 | extracted_data, structure_info |
| **DraftItem** | 생성된 문항 초안 | P3 | stem, choices, image_specs[] |
| **ValidationReport** | 검증 결과 | P4 | status, checks[], failure_codes[] |
| **FinalItem** | 최종 승인 문항 | P5 | item + generated_images[] |

### 8.2 상세 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            P1-INPUT                                     │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │  QTI/IML     │    │   Images     │    │  Metadata    │              │
│  │  원본 문항    │    │  원본 이미지  │    │  과목/학년   │              │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘              │
│         │                   │                   │                       │
│         └───────────────────┼───────────────────┘                       │
│                             ▼                                           │
│                      ┌─────────────┐                                    │
│                      │  InputPack  │                                    │
│                      │             │                                    │
│                      │ - qti_item  │ (원본 텍스트 구조)                  │
│                      │ - images[]  │ (이미지 정보)                       │
│                      │ - positions[]│ (이미지 위치) ⭐                   │
│                      │ - subject   │                                    │
│                      │ - variation │                                    │
│                      └──────┬──────┘                                    │
└─────────────────────────────┼───────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           P2-ANALYZE                                    │
│                      ┌─────────────┐                                    │
│                      │   AG-VIS    │◄─── Gemini 3 Flash                │
│                      │             │                                    │
│                      │ 이미지 분석: │                                    │
│                      │ - 그래프 수치│                                    │
│                      │ - 도형 좌표  │                                    │
│                      │ - 텍스트 추출│                                    │
│                      └──────┬──────┘                                    │
│                             ▼                                           │
│                      ┌─────────────┐                                    │
│                      │EvidencePack │                                    │
│                      │             │                                    │
│                      │- extracted_ │ {A: 85, B: 72, C: 91}             │
│                      │  data       │                                    │
│                      │- structure  │ "bar_chart, 3 bars"               │
│                      │- facts[]    │ ["A가 최대", "B가 최소"]            │
│                      └──────┬──────┘                                    │
└─────────────────────────────┼───────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          P3-GENERATE                                    │
│         ┌─────────────┐                                                 │
│         │   AG-GEN    │◄─── Gemini 3 Flash                             │
│         │             │                                                 │
│         │ 입력:       │                                                 │
│         │ - InputPack │ (원본 구조)                                     │
│         │ - Evidence  │ (분석 결과)                                     │
│         │ - variation │ (변형 유형)                                     │
│         │             │                                                 │
│         │ 처리:       │                                                 │
│         │ - 수치 변형 │ {A: 78, B: 65, C: 82}                          │
│         │ - 문항 생성 │                                                 │
│         │ - 위치 유지 │ ⭐                                              │
│         └──────┬──────┘                                                 │
│                ▼                                                        │
│         ┌─────────────┐                                                 │
│         │  DraftItem  │                                                 │
│         │             │                                                 │
│         │ - stem      │ "A반 78점, B반 65점..."                        │
│         │ - choices[] │                                                 │
│         │ - answer    │                                                 │
│         │ - image_    │ ⭐ [{position: "after_stem",                   │
│         │   specs[]   │      data: {A: 78, B: 65, C: 82}}]             │
│         └──────┬──────┘                                                 │
└─────────────────────────────┼───────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          P4-VALIDATE                                    │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │
│    │ AG-VAL  │  │AG-CALC  │  │AG-FACT  │  │AG-SAFE  │                  │
│    │ 기본검증 │  │계산검증  │  │사실검증  │  │안전검증  │                  │
│    └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                  │
│         └────────────┴────────────┴────────────┘                        │
│                             │                                           │
│                             ▼                                           │
│                   ┌──────────────────┐                                  │
│                   │ ValidationReport │                                  │
│                   │                  │                                  │
│                   │ - status: PASS   │                                  │
│                   │ - checks[]       │                                  │
│                   └────────┬─────────┘                                  │
└────────────────────────────┼────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           P5-OUTPUT                                     │
│    ┌─────────────┐                    ┌─────────────┐                   │
│    │   AG-IMG    │◄─── Nano Banana   │   AG-STD    │                   │
│    │             │     Pro           │             │                   │
│    │ 이미지 생성: │                    │ QTI 변환:   │                   │
│    │ - 새 수치   │                    │ - 표준 포맷 │                   │
│    │ - 원본 위치 │ ⭐                 │ - 메타데이터│                   │
│    └──────┬──────┘                    └──────┬──────┘                   │
│           │                                  │                          │
│           └──────────────┬───────────────────┘                          │
│                          ▼                                              │
│                   ┌─────────────┐                                       │
│                   │  FinalItem  │                                       │
│                   │             │                                       │
│                   │ - item_id   │                                       │
│                   │ - stem      │                                       │
│                   │ - choices[] │                                       │
│                   │ - images[]  │ ⭐ 원본 위치에 새 이미지              │
│                   │ - qti_xml   │                                       │
│                   └─────────────┘                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. QTI/IML 지원

### 9.1 지원 포맷

| 포맷 | 버전 | 지원 | 비고 |
|------|------|:----:|------|
| **IML** | - | ✅ | 한국 교육 문항 표준 (우선 지원) |
| QTI | 2.1 | ⚠️ | 향후 지원 예정 |
| QTI | 3.0 | ⚠️ | 향후 지원 예정 |

### 9.2 지원 문항 유형

| 유형 | IML 코드 | QTI Interaction | 지원 |
|------|----------|-----------------|:----:|
| 객관식 (5지선다) | qt="11" | choiceInteraction | ✅ |
| 진위형 | qt="21" | choiceInteraction | ✅ |
| 단답형 | qt="31" | textEntryInteraction | ⚠️ |
| 서술형 | qt="41" | extendedTextInteraction | ⚠️ |

---

## 10. API 인터페이스

### 10.1 문항 생성

```http
POST /api/v1/items/generate
Content-Type: application/json

{
  "source_item_id": "string",        // 원본 문항 ID (옵션)
  "source_image": "base64 | url",    // 이미지 (옵션)
  "variation_type": "similar | diff_up | diff_down | new",
  "subject": "math | science | korean | english | history | social",
  "grade": "string",
  "options": {
    "preserve_image_position": true,  // 이미지 위치 유지
    "generate_new_image": true,       // 새 이미지 생성
    "image_resolution": "1K | 2K | 4K"
  }
}
```

### 10.2 배치 생성

```http
POST /api/v1/items/generate/batch
```

### 10.3 검증

```http
POST /api/v1/items/validate
GET /api/v1/items/{item_id}/validation
```

### 10.4 조회

```http
GET /api/v1/items/{item_id}
GET /api/v1/items?subject=math&grade=middle-2
```

---

## 11. 성능 요구사항

| 지표 | 이미지 없음 | 이미지 포함 | 비고 |
|------|-----------|-----------|------|
| 단일 문항 생성 | < 30초 | < 90초 | P5 이미지 생성 포함 |
| 배치 처리량 | 120문항/시간 | 40문항/시간 | |
| API 응답 시간 | < 100ms | - | 조회 API |
| 검증 통과율 | > 75% | > 75% | |
| 시스템 가용성 | > 99.5% | > 99.5% | |

---

## 12. 검증 레벨

| 레벨 | 모델 수 | 사용 모델 | 적용 상황 |
|------|--------|----------|----------|
| Level 1 | 1 | Gemini Flash | 일반 문항 (수학, 과학) |
| Level 2 | 2 | + GPT-4o | 역사/사회 (사실 검증) |
| Level 3 | 3 | + Gemini Pro | 민감 주제, 언어 과목 |
| Level 4 | 3+ | + 전문가 검토 | 공식 시험 출제용 |

---

## 13. 보안

### 13.1 데이터 보안

- API Key 암호화 저장
- 전송 구간 TLS 1.3
- 문항 데이터 암호화

### 13.2 접근 제어

- API Key 기반 인증
- Rate Limiting
- IP Whitelist (옵션)

---

## 14. 오류 코드

| 코드 | 단계 | 의미 | 처리 |
|------|------|------|------|
| E001 | P1 | 입력 파싱 실패 | 요청 반려 |
| E002 | P2 | Vision 분석 실패 | 재시도 (3회) |
| E003 | P3 | 생성 실패 | 재시도 (3회) |
| E004 | P4 | 계산 검증 실패 | 재생성 |
| E005 | P4 | 사실 검증 실패 | 즉시 폐기 |
| E006 | P4 | 편향/안전 위반 | 전문가 검토 |
| E007 | P5 | 이미지 생성 실패 | 텍스트 전용 출력 |
| E008 | P5 | 위치 보존 실패 | 기본 위치 적용 |
| E009 | ALL | 타임아웃 | 재시도 (3회) |

---

## 15. 참조 문서

| 문서 | 설명 |
|------|------|
| [파이프라인 명세](pipeline/README.md) | P1-P5 파이프라인 상세 |
| [Nano Banana Pro 연구](../research/NANO-BANANA-PRO-RESEARCH.md) | 이미지 생성 모델 분석 |

---

## 개정 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v1.0.0 | 2026-02-01 | 초기 작성 |
| v1.1.0 | 2026-02-01 | Multi-Model Validation Strategy 추가 |
| v1.2.0 | 2026-02-02 | 입력 시나리오, 변형 유형, 과목별 처리, 이미지 위치 보존 추가 |
| v1.3.0 | 2026-02-02 | Level 3 모델 Gemini Pro로 변경, AG-IMG(이미지 정합성 검증) P4에 추가 |

---

**문서 끝**
